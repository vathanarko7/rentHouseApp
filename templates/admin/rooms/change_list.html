{% extends "admin/change_list.html" %}
{% block object-tools %}
{{ block.super }}
{% endblock %}
{% block search %}
{{ block.super }}
<style>
  #changelist-search .search-clear-btn {
    margin-left: 6px;
  }
</style>
<script>
  (function () {
    var form = document.getElementById("changelist-search");
    if (!form) return;
    var input = form.querySelector('input[name="q"]');
    if (!input || !input.value) return;

    var btn = document.createElement("button");
    btn.type = "button";
    btn.className = "button search-clear-btn";
    btn.textContent = "Clear";
    btn.addEventListener("click", function () {
      input.value = "";
      form.submit();
    });

    input.insertAdjacentElement("afterend", btn);
  })();
</script>

<script>
  (function () {
    var btn = document.getElementById("bulk-send-telegram-btn");
    if (!btn) return;
    btn.addEventListener("click", function () {
      var form = document.getElementById("changelist-form");
      if (!form) return;
      var actionSelect = form.querySelector('select[name="action"]');
      if (!actionSelect) return;
      var anyChecked = form.querySelectorAll('input.action-select:checked').length > 0;
      if (!anyChecked) {
        var warnModal = document.getElementById("bulk-send-warning-modal");
        if (warnModal) {
          warnModal.classList.add("is-open");
          warnModal.setAttribute("aria-hidden", "false");
          var warnOk = document.getElementById("bulk-send-warning-ok");
          var warnBackdrop = warnModal.querySelector(".confirm-modal__backdrop");
          function closeWarn() {
            warnModal.classList.remove("is-open");
            warnModal.setAttribute("aria-hidden", "true");
          }
          if (warnOk) warnOk.onclick = closeWarn;
          if (warnBackdrop) warnBackdrop.onclick = closeWarn;
        } else {
          alert("Select at least one invoice first.");
        }
        return;
      }
      var modal = document.getElementById("bulk-send-modal");
      if (!modal) {
        actionSelect.value = "bulk_send_telegram";
        form.submit();
        return;
      }
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
      var okBtn = document.getElementById("bulk-send-confirm");
      var cancelBtn = document.getElementById("bulk-send-cancel");
      var backdrop = modal.querySelector(".confirm-modal__backdrop");
      function closeModal() {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
      }
      if (okBtn) {
        okBtn.onclick = function () {
          closeModal();
          actionSelect.value = "bulk_send_telegram";
          form.submit();
        };
      }
      if (cancelBtn) {
        cancelBtn.onclick = function () {
          closeModal();
        };
      }
      if (backdrop) {
        backdrop.onclick = closeModal;
      }
    });
  })();
</script>
<script>
  (function () {
    function setupAutoRefresh() {
      var table = document.getElementById("result_list");
      if (!table) return;
      var jobSpans = table.querySelectorAll('.field-alert_job [data-job-pending="1"]');
      if (!jobSpans.length) return;
      var hasJob = true;
      if (!hasJob) return;
      var refreshMs = 10000;
      setTimeout(function () {
        window.location.reload();
      }, refreshMs);
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", setupAutoRefresh);
    } else {
      setupAutoRefresh();
    }
  })();
</script>
<script>
  (function () {
    var table = document.getElementById("result_list");
    if (!table) return;
    var rows = table.querySelectorAll("tbody tr");
    rows.forEach(function (row) {
      var failed = row.querySelector(
        '.field-alert_job [data-job-result="1"][data-job-status="failed"]'
      );
      if (failed) row.classList.add("job-failed");
    });
  })();
</script>
<script>
  (function () {
    var table = document.getElementById("result_list");
    if (!table) return;

    function getList() {
      var list = document.querySelector(".messagelist");
      if (!list) {
        list = document.createElement("ul");
        list.className = "messagelist";
        document.body.appendChild(list);
      }
      return list;
    }

    function showToast(kind, message) {
      var list = getList();
      var li = document.createElement("li");
      li.className = kind;
      li.textContent = message;

      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "msg-close";
      btn.setAttribute("aria-label", "Close");
      btn.textContent = "Ã—";
      btn.addEventListener("click", function () {
        li.classList.add("is-fading");
        setTimeout(function () {
          li.style.display = "none";
        }, 400);
      });
      li.appendChild(btn);
      list.appendChild(li);

      setTimeout(function () {
        li.classList.add("is-fading");
        setTimeout(function () {
          li.style.display = "none";
        }, 400);
      }, 5000);
    }

    var storageKey = "monthlybillJobPending";
    var shownKey = "monthlybillJobShown";
    var prev = [];
    var shown = {};
    try {
      prev = JSON.parse(localStorage.getItem(storageKey) || "[]");
    } catch (e) {}
    try {
      shown = JSON.parse(localStorage.getItem(shownKey) || "{}");
    } catch (e) {}

    var current = [];
    var pendingSpans = table.querySelectorAll('.field-alert_job [data-job-pending="1"]');
    pendingSpans.forEach(function (span) {
      var id = span.getAttribute("data-bill-id");
      if (id) current.push(id);
    });

    prev.forEach(function (id) {
      if (current.indexOf(id) !== -1) return;
      var result = table.querySelector(
        '.field-alert_job [data-job-result="1"][data-bill-id="' + id + '"]'
      );
      if (!result) return;
      var status = (result.getAttribute("data-job-status") || "").toLowerCase();
      var msg = result.getAttribute("data-job-message") || "";
      var signature = status + "|" + msg;
      if (shown[id] === signature) return;
      shown[id] = signature;

      var kind = status === "success" ? "success" : status === "failed" ? "error" : "info";
      var text =
        msg ||
        (status === "success"
          ? "Job completed successfully."
          : status === "failed"
          ? "Job failed."
          : "Job updated.");
      showToast(kind, text);
    });

    localStorage.setItem(storageKey, JSON.stringify(current));
    localStorage.setItem(shownKey, JSON.stringify(shown));
  })();
</script>
{% endblock %} {% block content %} {% if generate_invoice_url and rooms %}
<div style="margin: 12px 0 16px 0">
  <div
    class="object-tools"
    style="margin-bottom: 8px; float: none; display: flex; gap: 8px; align-items: center; justify-content: space-between;"
  >
    <div style="display:flex; gap:8px; align-items:center;">
      <button
        type="button"
        class="button"
        data-action="{{ generate_invoice_url }}"
        data-title="Generate Monthly Bills"
        data-submit="Generate"
      >
        Generate Monthly Bills
      </button>
      <button
        type="button"
        class="button"
        data-action="{{ bulk_download_url }}"
        data-title="Bulk Download Bills"
        data-submit="Download ZIP"
      >
        Bulk Download Bills
      </button>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button type="button" class="button" id="bulk-send-telegram-btn">
        Bulk Send via Telegram
      </button>
    </div>
  </div>

  <div class="confirm-modal" id="bulk-send-modal" aria-hidden="true">
    <div class="confirm-modal__backdrop"></div>
    <div class="confirm-modal__panel" role="dialog" aria-modal="true">
      <h3 class="confirm-modal__title">Bulk Send</h3>
      <p>Send selected invoices via Telegram?</p>
      <div class="confirm-modal__actions">
        <button type="button" class="button confirm-cancel" id="bulk-send-cancel">Cancel</button>
        <button type="button" class="button confirm-ok confirm-send" id="bulk-send-confirm">Send</button>
      </div>
    </div>
  </div>
  <div class="confirm-modal" id="bulk-send-warning-modal" aria-hidden="true">
    <div class="confirm-modal__backdrop"></div>
    <div class="confirm-modal__panel" role="dialog" aria-modal="true">
      <h3 class="confirm-modal__title">Select invoices</h3>
      <p>Select at least one invoice first.</p>
      <div class="confirm-modal__actions">
        <button type="button" class="button confirm-ok" id="bulk-send-warning-ok">OK</button>
      </div>
    </div>
  </div>

  <style>
    :root {
      --invoice-card-bg: var(--body-bg, #fbfcfd);
      --invoice-card-border: var(--border-color, #e1e4e8);
      --invoice-muted: var(--body-quiet-color, #6b7280);
      --invoice-field-border: var(--border-color, #cbd5e1);
      --invoice-panel-bg: var(--body-bg, #ffffff);
      --invoice-panel-border: var(--border-color, #e5e7eb);
      --invoice-hover: var(--hairline-color, #f3f6fb);
      --invoice-text: var(--body-fg, #111827);
      --invoice-primary: var(--primary, #16a34a);
      --invoice-primary-border: var(--primary, #12823b);
      --invoice-primary-hover: var(--primary, #12823b);
      --invoice-selected: var(--primary, #2c6fbb);
      --invoice-selected-border: var(--primary, #1f5b9c);
    }

    .object-tools .button.is-selected {
      background: var(--invoice-selected);
      border-color: var(--invoice-selected-border);
      color: #fff;
    }

    .invoice-card {
      border: 1px solid var(--invoice-card-border);
      border-radius: 10px;
      padding: 16px;
      background: var(--invoice-card-bg);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      max-width: 860px;
      color: var(--invoice-text);
    }

    .invoice-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .invoice-subtitle {
      color: var(--invoice-muted);
      font-size: 13px;
      margin: 0;
    }

    .invoice-field {
      margin: 12px 0 8px 0;
    }

    .invoice-field label {
      display: inline-block;
      margin-bottom: 6px;
      color: var(--invoice-text);
    }

    .month-input {
      padding: 6px 10px;
      border: 1px solid var(--invoice-field-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--invoice-panel-bg);
      color: var(--invoice-text);
    }
    .month-picker {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .month-picker-btn {
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .month-picker-icon {
      width: 16px;
      height: 16px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .month-popover {
      position: relative;
      display: inline-block;
    }
    .month-popover-panel {
      position: absolute;
      top: 38px;
      left: 0;
      z-index: 2000;
      background: var(--body-bg, #fff);
      border: 1px solid var(--border-color, #ddd);
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      padding: 10px;
      width: 240px;
      display: none;
    }
    .month-popover-panel.is-open {
      display: block;
    }
    .month-popover-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .month-popover-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    .month-popover-grid button {
      padding: 6px 4px;
      border: 1px solid var(--border-color, #e5e7eb);
      border-radius: 6px;
      background: var(--body-bg, #fff);
      cursor: pointer;
    }
    .month-popover-grid button:hover {
      background: var(--hairline-color, #f3f6fb);
    }

    .rooms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 6px 12px;
      margin-top: 8px;
      max-height: 240px;
      overflow: auto;
      padding: 8px;
      border: 1px solid var(--invoice-panel-border);
      border-radius: 8px;
      background: var(--invoice-panel-bg);
    }

    .room-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 6px;
      border-radius: 6px;
    }

    .room-option:hover {
      background: var(--invoice-hover);
    }

    .btn-generate {
      background: var(--invoice-primary);
      border: 1px solid var(--invoice-primary-border);
      color: #fff;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 8px;
    }

    .btn-generate:hover {
      background: var(--invoice-primary-hover);
    }

    .btn-clear {
      background: #f97316;
      border: 1px solid #ea580c;
      color: #fff;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 8px;
    }

    .btn-clear:hover {
      background: #ea580c;
    }

    .btn-clear:disabled {
      background: var(--border-color, #cbd5e1);
      border-color: var(--border-color, #cbd5e1);
      color: var(--body-quiet-color, #6b7280);
      cursor: not-allowed;
    }
    .btn-close {
      background: var(--button-bg, #6b7280);
      border: 1px solid var(--button-border, #4b5563);
      color: var(--button-fg, #fff);
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 8px;
      margin-left: 6px;
    }
    .btn-close:hover {
      background: var(--button-hover-bg, #4b5563);
    }
  </style>

  <p id="invoice-action-note" style="margin: 4px 0 10px 0; color: #5a5a5a">
    Select a billing action to show the form.
  </p>

  <div id="invoice-form-wrapper" style="display: none">
    <div class="invoice-card">
      <div class="invoice-header">
        <h2 id="invoice-form-title" style="margin: 0">
          Generate Monthly Bills
        </h2>
        <p class="invoice-subtitle">
          Pick a month and rooms, then run the action.
        </p>
      </div>
      <form method="post" id="invoice-form" action="">
        {% csrf_token %}

        <div class="invoice-field">
          <label><strong>Month:</strong></label
          ><br />
          <div class="month-picker">
            <input type="month" name="month" class="month-input" required />
            <div class="month-popover">
              <button type="button" class="button month-picker-btn" aria-label="Pick month">
                <svg class="month-picker-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M7 2v3M17 2v3M3 8h18M5 6h14a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
                </svg>
              </button>
              <div class="month-popover-panel" aria-hidden="true">
                <div class="month-popover-header">
                  <select class="month-year-select" aria-label="Year"></select>
                  <button type="button" class="button month-popover-close">Close</button>
                </div>
                <div class="month-popover-grid">
                  <button type="button" data-month="01">Jan</button>
                  <button type="button" data-month="02">Feb</button>
                  <button type="button" data-month="03">Mar</button>
                  <button type="button" data-month="04">Apr</button>
                  <button type="button" data-month="05">May</button>
                  <button type="button" data-month="06">Jun</button>
                  <button type="button" data-month="07">Jul</button>
                  <button type="button" data-month="08">Aug</button>
                  <button type="button" data-month="09">Sep</button>
                  <button type="button" data-month="10">Oct</button>
                  <button type="button" data-month="11">Nov</button>
                  <button type="button" data-month="12">Dec</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h3>Rooms</h3>
        <p class="invoice-subtitle"><em>(Leave unchecked = all rooms)</em></p>

        <div class="rooms-grid">
          {% for room in rooms %}
          <label class="room-option">
            <input type="checkbox" name="rooms" value="{{ room.id }}" />
            {{ room.room_number }}
          </label>
          {% endfor %}
        </div>

        <br />
        <button class="btn-generate" id="invoice-form-submit">Submit</button>
        <button type="reset" class="btn-clear" id="invoice-form-clear" disabled>
          Clear
        </button>
        <button type="button" class="btn-close" id="invoice-form-close" style="float:right;">
          Close
        </button>
      </form>
    </div>
  </div>
</div>


<script>
  (function () {
    var buttons = document.querySelectorAll(".object-tools [data-action]");
    var formWrapper = document.getElementById("invoice-form-wrapper");
    var form = document.getElementById("invoice-form");
    var title = document.getElementById("invoice-form-title");
    var submit = document.getElementById("invoice-form-submit");
    var note = document.getElementById("invoice-action-note");
    var clearBtn = document.getElementById("invoice-form-clear");
    var closeBtn = document.getElementById("invoice-form-close");

    if (
      !buttons.length ||
      !form ||
      !title ||
      !submit ||
      !formWrapper ||
      !note ||
      !clearBtn ||
      !closeBtn
    )
      return;

    function setActive(button) {
      buttons.forEach(function (btn) {
        btn.setAttribute("aria-pressed", "false");
        btn.classList.remove("is-selected");
      });
      button.setAttribute("aria-pressed", "true");
      button.classList.add("is-selected");
      form.setAttribute("action", button.getAttribute("data-action"));
      title.textContent = button.getAttribute("data-title");
      submit.textContent = button.getAttribute("data-submit");
      note.textContent =
        "Selected action: " + button.getAttribute("data-title");
      formWrapper.style.display = "block";
    }

    function updateClearState() {
      clearBtn.disabled = !form || !form.checkValidity() || form.pristine;
    }

    form.addEventListener("input", function () {
      form.pristine = false;
      clearBtn.disabled = false;
    });

    form.addEventListener("change", function () {
      form.pristine = false;
      clearBtn.disabled = false;
    });

    form.addEventListener("reset", function () {
      setTimeout(function () {
        form.pristine = true;
        clearBtn.disabled = true;
      }, 0);
    });

    var monthInput = form.querySelector('input[name="month"]');
    var monthPickBtn = form.querySelector(".month-picker-btn");
    var monthPopover = form.querySelector(".month-popover-panel");
    var monthClose = form.querySelector(".month-popover-close");
    var yearSelect = form.querySelector(".month-year-select");
    var monthButtons = form.querySelectorAll(".month-popover-grid button[data-month]");

    if (yearSelect) {
      var now = new Date();
      var currentYear = now.getFullYear();
      var startYear = currentYear;
      var endYear = currentYear - 15;
      for (var y = startYear; y >= endYear; y--) {
        var opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        yearSelect.appendChild(opt);
      }
      yearSelect.value = String(currentYear);
    }

    function openMonthPopover() {
      if (!monthPopover) return;
      monthPopover.classList.add("is-open");
      monthPopover.setAttribute("aria-hidden", "false");
    }
    function closeMonthPopover() {
      if (!monthPopover) return;
      monthPopover.classList.remove("is-open");
      monthPopover.setAttribute("aria-hidden", "true");
    }

    if (monthPickBtn) {
      monthPickBtn.addEventListener("click", function () {
        openMonthPopover();
      });
    }
    if (monthClose) {
      monthClose.addEventListener("click", closeMonthPopover);
    }

    function updateMonthAvailability() {
      if (!yearSelect) return;
      var now = new Date();
      var currentYear = now.getFullYear();
      var currentMonth = now.getMonth() + 1;
      var selectedYear = parseInt(yearSelect.value, 10);
      monthButtons.forEach(function (btn) {
        var m = parseInt(btn.getAttribute("data-month"), 10);
        var isFuture = selectedYear === currentYear && m > currentMonth;
        btn.disabled = isFuture;
        btn.style.opacity = isFuture ? "0.4" : "1";
        btn.style.cursor = isFuture ? "not-allowed" : "pointer";
      });
    }

    if (yearSelect) {
      yearSelect.addEventListener("change", updateMonthAvailability);
      updateMonthAvailability();
    }

    monthButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        if (!monthInput || !yearSelect) return;
        if (btn.disabled) return;
        monthInput.value = yearSelect.value + "-" + btn.getAttribute("data-month");
        monthInput.dispatchEvent(new Event("input", { bubbles: true }));
        closeMonthPopover();
      });
    });

    buttons.forEach(function (button) {
      button.addEventListener("click", function () {
        setActive(button);
        form.pristine = true;
        clearBtn.disabled = true;
      });
    });

    closeBtn.addEventListener("click", function () {
      if (form) {
        form.reset();
        form.pristine = true;
        clearBtn.disabled = true;
      }
      formWrapper.style.display = "none";
      note.textContent = "Select a billing action to show the form.";
      buttons.forEach(function (btn) {
        btn.setAttribute("aria-pressed", "false");
        btn.classList.remove("is-selected");
      });
    });
  })();
</script>

{% endif %}
{{ block.super }}

<div id="invoice-preview-modal" style="display: none">
  <div class="preview-backdrop"></div>
  <div class="preview-panel">
    <button type="button" class="preview-close">Close</button>
    <img id="invoice-preview-image" alt="Invoice Preview" />
  </div>
</div>

<style>
  #invoice-preview-modal {
    position: fixed;
    inset: 0;
    z-index: 3000;
  }
  #invoice-preview-modal .preview-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.55);
  }
  #invoice-preview-modal .preview-panel {
    position: relative;
    margin: 5vh auto;
    width: min(900px, 90vw);
    background: var(--body-bg, #fff);
    border: 1px solid var(--border-color, #ddd);
    border-radius: 8px;
    padding: 12px;
    max-height: 90vh;
    overflow: auto;
  }
  #invoice-preview-modal img {
    width: 100%;
    height: auto;
    display: block;
  }
  #invoice-preview-modal .preview-close {
    float: right;
    margin-bottom: 8px;
  }

  .preview-btn {
    background: linear-gradient(180deg, #3b82f6, #2563eb);
    border: 1px solid #1d4ed8;
    color: #fff;
    font-weight: 600;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-align: center;
    box-sizing: border-box;
    box-shadow: 0 1px 2px rgba(37, 99, 235, 0.35);
  }
  .preview-btn:hover {
    background: linear-gradient(180deg, #2563eb, #1d4ed8);
  }

  .regen-btn {
    background: #f59e0b;
    border-color: #d97706;
    color: #fff;
    font-weight: 600;
    padding: 4px 10px;
    display: inline-block;
    text-align: center;
    box-sizing: border-box;
  }
  .regen-btn:hover {
    background: #d97706;
  }

  .send-btn {
    background: linear-gradient(180deg, #a855f7, #8b5cf6);
    border: 1px solid #7c3aed;
    color: #fff;
    font-weight: 600;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-align: center;
    box-sizing: border-box;
    box-shadow: 0 1px 2px rgba(139, 92, 246, 0.35);
  }
  .send-btn:hover {
    background: linear-gradient(180deg, #8b5cf6, #7c3aed);
  }

  .download-btn {
    background: linear-gradient(180deg, #34d399, #10b981);
    border: 1px solid #059669;
    color: #fff;
    font-weight: 600;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-align: center;
    box-sizing: border-box;
    box-shadow: 0 1px 2px rgba(16, 185, 129, 0.35);
  }
  .download-btn:hover {
    background: linear-gradient(180deg, #10b981, #059669);
  }
  .issue-btn {
    background: linear-gradient(180deg, #f97316, #f59e0b);
    border: 1px solid #d97706;
    color: #fff;
    font-weight: 600;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-align: center;
    box-sizing: border-box;
    box-shadow: 0 1px 2px rgba(245, 158, 11, 0.35);
  }
  .issue-btn:hover {
    background: linear-gradient(180deg, #f59e0b, #d97706);
  }
  .paid-btn {
    background: linear-gradient(180deg, #22c55e, #16a34a);
    border: 1px solid #15803d;
    color: #fff;
    font-weight: 600;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-align: center;
    box-sizing: border-box;
    box-shadow: 0 1px 2px rgba(22, 163, 74, 0.35);
  }
  .paid-btn:hover {
    background: linear-gradient(180deg, #16a34a, #15803d);
  }
</style>

<script>
  (function () {
    var modal = document.getElementById("invoice-preview-modal");
    if (!modal) return;
    var img = document.getElementById("invoice-preview-image");
    var closeBtn = modal.querySelector(".preview-close");
    var backdrop = modal.querySelector(".preview-backdrop");

    function close() {
      modal.style.display = "none";
      if (img) img.src = "";
    }

    function open(url) {
      if (!url || !img) return;
      img.src = url;
      modal.style.display = "block";
    }

    document.addEventListener("click", function (e) {
      var btn = e.target.closest(".preview-invoice-btn");
      if (btn) {
        e.preventDefault();
        open(btn.getAttribute("data-preview-url"));
      }
    });

    if (closeBtn) closeBtn.addEventListener("click", close);
    if (backdrop) backdrop.addEventListener("click", close);
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") close();
    });
  })();
</script>
{% endblock %}
  .btn-sm {
    padding: 4px 10px;
    font-size: 12px;
    line-height: 1.2;
  }
  .btn-lg {
    padding: 8px 16px;
    font-size: 14px;
    line-height: 1.3;
  }
