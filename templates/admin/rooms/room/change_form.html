{% extends "admin/change_form.html" %}
{% load static %}
{% load i18n %}

{% block content %}
{{ block.super }}

<details class="utility-reading-section" style="margin-top: 24px;" open>
  <summary style="font-size: 16px; font-weight: 600; cursor: pointer;">
    {% translate "Utility Readings" %}
  </summary>
  <style>
    .chart-card {
      margin-top: 10px;
      background: color-mix(in srgb, var(--body-bg, #fff) 92%, transparent);
      border: 1px solid color-mix(in srgb, var(--border-color, #e5e7eb) 70%, transparent);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.08);
    }
    .chart-wrap {
      position: relative;
      width: 100%;
      height: 260px;
    }
    @media (max-width: 900px) {
      .chart-wrap { height: 220px; }
    }
    @media (max-width: 640px) {
      .chart-wrap { height: 200px; }
      .chart-card { padding: 12px; }
    }
    #electricity-chart {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
  <div class="chart-card">
    <div class="chart-wrap">
      <canvas id="electricity-chart"></canvas>
    </div>
  </div>
</details>


{{ electricity_chart_labels|json_script:"electricity-chart-labels" }}
{{ electricity_chart_datasets|json_script:"electricity-chart-datasets" }}
{{ electricity_chart_texts|json_script:"electricity-chart-texts" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    var isDark = document.documentElement.getAttribute("data-theme") === "dark";
    var gridColor = isDark ? "rgba(148, 163, 184, 0.25)" : "rgba(148, 163, 184, 0.18)";
    var textColor = isDark ? "#e2e8f0" : "#334155";
    var labelsEl = document.getElementById("electricity-chart-labels");
    var datasetsEl = document.getElementById("electricity-chart-datasets");
    if (!labelsEl || !datasetsEl) return;

    var labels = JSON.parse(labelsEl.textContent || "[]");
    var datasets = JSON.parse(datasetsEl.textContent || "[]");
    var textsEl = document.getElementById("electricity-chart-texts");
    var ctx = document.getElementById("electricity-chart");
    if (!ctx) return;
    var texts = textsEl ? JSON.parse(textsEl.textContent || "{}") : {};

    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true, color: textColor }, grid: { color: gridColor } },
          y: {
            beginAtZero: true,
            title: { display: true, text: texts.axis_readings || "Readings", color: textColor },
            ticks: { color: textColor },
            grid: { color: gridColor },
          },
        },
        plugins: {
          legend: {
            position: "top",
            labels: {
              color: textColor,
              boxWidth: 18,
              usePointStyle: true,
            },
          },
          tooltip: {
            backgroundColor: isDark ? "#111827" : "#0f172a",
            titleColor: "#fff",
            bodyColor: "#fff",
            padding: 10,
            cornerRadius: 8,
            callbacks: {
              label: function (context) {
                var label = context.dataset.label || "";
                var value = context.parsed.y;
                if (texts.label_electricity && label.includes(texts.label_electricity)) {
                  return (texts.tooltip_electricity || "Electricity") + ": " + value + " kWh";
                }
                if (texts.label_water && label.includes(texts.label_water)) {
                  return (texts.tooltip_water || "Water") + ": " + value + " mÂ³";
                }
                return label + ": " + value;
              },
            },
          },
        },
      },
    });
  })();
</script>
{% endblock %}
