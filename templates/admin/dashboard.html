{% extends "admin/base_site.html" %}
{% load i18n log %}

{% block content_title %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:dashboard' %}">{% translate "Home" %}</a>
  &rsaquo;
  {% translate "Reports & Dashboard" %}
</div>
{% endblock %}

{% block content %}
<h1>{% translate "Reports & Dashboard" %}</h1>

{% if is_tenant %}
<p>{% translate "Showing your room data only." %}</p>
{% else %}
<p>{% translate "Showing all rooms (global view)." %}</p>
{% endif %}

<style>
  .dashboard-section {
    margin-top: 16px;
  }
  .dashboard-section summary {
    cursor: pointer;
    font-weight: 600;
    list-style: none;
  }
  .dashboard-section summary::-webkit-details-marker {
    display: none;
  }
  .chart-card {
    margin-top: 10px;
    background: color-mix(in srgb, var(--body-bg, #fff) 92%, transparent);
    border: 1px solid color-mix(in srgb, var(--border-color, #e5e7eb) 70%, transparent);
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 10px 26px rgba(0, 0, 0, 0.08);
  }
  .chart-wrap {
    position: relative;
    width: 100%;
    height: 260px;
  }
  @media (max-width: 900px) {
    .chart-wrap {
      height: 220px;
    }
  }
  @media (max-width: 640px) {
    .chart-wrap {
      height: 200px;
    }
    .chart-card {
      padding: 12px;
    }
  }
  #income-chart,
  #usage-chart {
    width: 100% !important;
    height: 100% !important;
  }
</style>

<section class="dashboard-section">
  <h2 style="margin: 0 0 8px; font-size: 16px; font-weight: 600;">
    {% if is_tenant %}
      {% translate "Expense per Month" %}
    {% else %}
      {% translate "Income per Month" %}
    {% endif %}
  </h2>
  <div class="chart-card">
    <div class="chart-wrap">
      <canvas id="income-chart"></canvas>
    </div>
  </div>
</section>

<section class="dashboard-section" style="margin-top: 24px;">
  <h2 style="margin: 0 0 8px; font-size: 16px; font-weight: 600;">
    {% translate "Water / Electricity Trends" %}
  </h2>
  <div class="chart-card">
    <div class="chart-wrap">
      <canvas id="usage-chart"></canvas>
    </div>
  </div>
</section>

<details style="margin-top: 24px;">
  <summary style="cursor:pointer; font-weight:600;">{% translate "Recent actions" %}</summary>
  <div style="margin-top: 10px;">
    {% get_admin_log 10 as admin_log for_user user %}
    {% if not admin_log %}
      <p class="quiet">{% translate "None available" %}</p>
    {% else %}
      <table class="actionlist" style="width:100%; border-collapse:collapse;">
        <tbody>
          {% for entry in admin_log %}
            <tr class="{% if entry.is_addition %}addlink{% elif entry.is_change %}changelink{% elif entry.is_deletion %}deletelink{% endif %}">
              <td style="padding:6px 8px;">
                {% if entry.is_deletion or not entry.get_admin_url %}
                  {{ entry.object_repr }}
                {% else %}
                  <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
                {% endif %}
              </td>
              <td class="mini quiet" style="padding:6px 8px; text-align:right;">
                {% if entry.content_type %}{{ entry.content_type.name|capfirst }}{% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</details>

{{ income_labels|json_script:"income-labels" }}
{{ income_values|json_script:"income-values" }}
{{ water_labels|json_script:"water-labels" }}
{{ water_values|json_script:"water-values" }}
{{ elec_labels|json_script:"elec-labels" }}
{{ elec_values|json_script:"elec-values" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    var isDark = document.documentElement.getAttribute("data-theme") === "dark";
    var gridColor = isDark ? "rgba(148, 163, 184, 0.25)" : "rgba(148, 163, 184, 0.18)";
    var textColor = isDark ? "#e2e8f0" : "#334155";

    var incomeLabels = JSON.parse(document.getElementById("income-labels").textContent || "[]");
    var incomeValues = JSON.parse(document.getElementById("income-values").textContent || "[]");
    var waterLabels = JSON.parse(document.getElementById("water-labels").textContent || "[]");
    var waterValues = JSON.parse(document.getElementById("water-values").textContent || "[]");
    var elecLabels = JSON.parse(document.getElementById("elec-labels").textContent || "[]");
    var elecValues = JSON.parse(document.getElementById("elec-values").textContent || "[]");

    var incomeCtx = document.getElementById("income-chart");
    if (incomeCtx) {
      new Chart(incomeCtx, {
        type: "line",
        data: {
          labels: incomeLabels,
          datasets: [
            {
              label: "{% if is_tenant %}{% translate "Expense (៛)" %}{% else %}{% translate "Income (៛)" %}{% endif %}",
              data: incomeValues,
              borderColor: "#16a34a",
              backgroundColor: "rgba(22, 163, 74, 0.18)",
              fill: true,
              tension: 0.35,
              pointRadius: 3,
              pointHoverRadius: 5,
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              position: "top",
              labels: {
                color: textColor,
                boxWidth: 18,
                usePointStyle: true,
              },
            },
            tooltip: {
              backgroundColor: isDark ? "#111827" : "#0f172a",
              titleColor: "#fff",
              bodyColor: "#fff",
              padding: 10,
              cornerRadius: 8,
            },
          },
          scales: {
            x: { grid: { color: gridColor }, ticks: { color: textColor } },
            y: {
              beginAtZero: true,
              grid: { color: gridColor },
              ticks: { color: textColor },
            },
          },
        },
      });
    }

    var usageCtx = document.getElementById("usage-chart");
    if (usageCtx) {
      new Chart(usageCtx, {
        type: "line",
        data: {
          labels: waterLabels.length ? waterLabels : elecLabels,
          datasets: [
            {
              label: "{% translate "Water (m³)" %}",
              data: waterValues,
              borderColor: "#0ea5e9",
              backgroundColor: "rgba(14, 165, 233, 0.14)",
              fill: true,
              tension: 0.35,
              pointRadius: 3,
              pointHoverRadius: 5,
              borderWidth: 2,
            },
            {
              label: "{% translate "Electricity (kWh)" %}",
              data: elecValues,
              borderColor: "#2563eb",
              backgroundColor: "rgba(37, 99, 235, 0.16)",
              fill: true,
              tension: 0.35,
              pointRadius: 3,
              pointHoverRadius: 5,
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              position: "top",
              labels: {
                color: textColor,
                boxWidth: 18,
                usePointStyle: true,
              },
            },
            tooltip: {
              backgroundColor: isDark ? "#111827" : "#0f172a",
              titleColor: "#fff",
              bodyColor: "#fff",
              padding: 10,
              cornerRadius: 8,
            },
          },
          scales: {
            x: { grid: { color: gridColor }, ticks: { color: textColor } },
            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
          },
        },
      });
    }
  })();
</script>
{% endblock %}





