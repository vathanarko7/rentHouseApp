{% extends "admin/base_site.html" %}
{% load i18n log %}

{% block content_title %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:dashboard' %}">{% translate "Home" %}</a>
  &rsaquo;
  {% translate "Reports & Dashboard" %}
</div>
{% endblock %}

{% block content %}
<h1>{% translate "Reports & Dashboard" %}</h1>

{% if is_tenant %}
<p>{% translate "Showing your room data only." %}</p>
{% else %}
<p>{% translate "Showing all rooms (global view)." %}</p>
{% endif %}

<details open style="margin-top: 16px;">
  <summary style="cursor:pointer; font-weight:600;">{% translate "Income per Month" %}</summary>
  <div style="margin-top: 10px;">
    <canvas id="income-chart" height="120"></canvas>
  </div>
</details>

<details style="margin-top: 24px;">
  <summary style="cursor:pointer; font-weight:600;">{% translate "Water / Electricity Trends" %}</summary>
  <div style="margin-top: 10px;">
    <canvas id="usage-chart" height="140"></canvas>
  </div>
</details>

<details style="margin-top: 24px;">
  <summary style="cursor:pointer; font-weight:600;">{% translate "Recent actions" %}</summary>
  <div style="margin-top: 10px;">
    {% get_admin_log 10 as admin_log for_user user %}
    {% if not admin_log %}
      <p class="quiet">{% translate "None available" %}</p>
    {% else %}
      <table class="actionlist" style="width:100%; border-collapse:collapse;">
        <tbody>
          {% for entry in admin_log %}
            <tr class="{% if entry.is_addition %}addlink{% elif entry.is_change %}changelink{% elif entry.is_deletion %}deletelink{% endif %}">
              <td style="padding:6px 8px;">
                {% if entry.is_deletion or not entry.get_admin_url %}
                  {{ entry.object_repr }}
                {% else %}
                  <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
                {% endif %}
              </td>
              <td class="mini quiet" style="padding:6px 8px; text-align:right;">
                {% if entry.content_type %}{{ entry.content_type.name|capfirst }}{% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</details>

{{ income_labels|json_script:"income-labels" }}
{{ income_values|json_script:"income-values" }}
{{ water_labels|json_script:"water-labels" }}
{{ water_values|json_script:"water-values" }}
{{ elec_labels|json_script:"elec-labels" }}
{{ elec_values|json_script:"elec-values" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    var incomeLabels = JSON.parse(document.getElementById("income-labels").textContent || "[]");
    var incomeValues = JSON.parse(document.getElementById("income-values").textContent || "[]");
    var waterLabels = JSON.parse(document.getElementById("water-labels").textContent || "[]");
    var waterValues = JSON.parse(document.getElementById("water-values").textContent || "[]");
    var elecLabels = JSON.parse(document.getElementById("elec-labels").textContent || "[]");
    var elecValues = JSON.parse(document.getElementById("elec-values").textContent || "[]");

    var incomeCtx = document.getElementById("income-chart");
    if (incomeCtx) {
      new Chart(incomeCtx, {
        type: "line",
        data: {
          labels: incomeLabels,
          datasets: [
            {
              label: "Income",
              data: incomeValues,
              borderColor: "#16a34a",
              backgroundColor: "rgba(22, 163, 74, 0.15)",
              fill: true,
              tension: 0.25,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    var usageCtx = document.getElementById("usage-chart");
    if (usageCtx) {
      new Chart(usageCtx, {
        type: "line",
        data: {
          labels: waterLabels.length ? waterLabels : elecLabels,
          datasets: [
            {
              label: "Water (mÂ³)",
              data: waterValues,
              borderColor: "#0ea5e9",
              backgroundColor: "rgba(14, 165, 233, 0.10)",
              fill: true,
              tension: 0.25,
            },
            {
              label: "Electricity (kWh)",
              data: elecValues,
              borderColor: "#2563eb",
              backgroundColor: "rgba(37, 99, 235, 0.12)",
              fill: true,
              tension: 0.25,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }
  })();
</script>
{% endblock %}
