{% extends "admin/base_site.html" %}
{% load i18n log admin_log_format %}

{% block content_title %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:dashboard' %}">{% translate "Home" %}</a>
  &rsaquo;
  {% translate "Reports & Dashboard" %}
</div>
{% endblock %}

{% block content %}
<h1>{% translate "Reports & Dashboard" %}</h1>

{% if is_tenant %}
<p>{% translate "Showing your room data only." %}</p>
{% else %}
<p>{% translate "Showing all rooms (global view)." %}</p>
{% endif %}

<style>
  .voice-summary {
    margin: 12px 0 6px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .voice-summary button {
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 600;
  }
  .voice-summary .voice-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--body-quiet-color, #6b7280);
  }
  .voice-summary .voice-toggle input {
    transform: translateY(1px);
  }
  .dashboard-section {
    margin-top: 16px;
  }
  .dashboard-section summary {
    cursor: pointer;
    font-weight: 600;
    list-style: none;
  }
  .dashboard-section summary::-webkit-details-marker {
    display: none;
  }
  .chart-card {
    margin-top: 10px;
    background: color-mix(in srgb, var(--body-bg, #fff) 92%, transparent);
    border: 1px solid color-mix(in srgb, var(--border-color, #e5e7eb) 70%, transparent);
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 10px 26px rgba(0, 0, 0, 0.08);
  }
  .recent-actions-status {
    opacity: 0.85;
    font-size: 12px;
    margin-top: 4px;
  }
  .recent-actions-status.status-success {
    color: #16a34a;
  }
  .recent-actions-status.status-failed {
    color: #dc2626;
  }
  @media (max-width: 768px) {
    .recent-actions-list li:last-child {
      margin-bottom: calc(var(--mobile-nav-space, 160px) + 12px);
    }
  }
  .chart-wrap {
    position: relative;
    width: 100%;
    height: 260px;
  }
  @media (max-width: 900px) {
    .chart-wrap {
      height: 220px;
    }
  }
  @media (max-width: 640px) {
    .chart-wrap {
      height: 200px;
    }
    .chart-card {
      padding: 12px;
    }
  }
  #income-chart,
  #usage-chart {
    width: 100% !important;
    height: 100% !important;
  }
  .recent-actions-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 8px;
  }
  .recent-actions-item {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 10px;
    background: color-mix(in srgb, var(--body-bg, #fff) 92%, transparent);
    border: 1px solid color-mix(in srgb, var(--border-color, #e5e7eb) 70%, transparent);
  }
  .recent-actions-main {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .recent-actions-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--body-quiet-color, #6b7280);
    font-weight: 600;
  }
  .recent-actions-object a {
    color: inherit;
    text-decoration: none;
  }
  .recent-actions-time {
    font-size: 11px;
    color: var(--body-quiet-color, #6b7280);
    white-space: nowrap;
  }
  .recent-actions-item.is-add {
    border-color: color-mix(in srgb, #10b981 30%, var(--border-color, #e5e7eb));
  }
  .recent-actions-item.is-change {
    border-color: color-mix(in srgb, #3b82f6 30%, var(--border-color, #e5e7eb));
  }
  .recent-actions-item.is-delete {
    border-color: color-mix(in srgb, #ef4444 30%, var(--border-color, #e5e7eb));
  }
</style>

<div class="voice-summary">
  <button type="button" class="button" id="voice-summary-play">{% translate "Play summary" %}</button>
  <label class="voice-toggle">
    <input type="checkbox" id="voice-summary-auto" />
    {% translate "Auto play" %}
  </label>
</div>
<p id="voice-summary-display" class="voice-summary-text" style="margin: 6px 0 0; color: var(--body-quiet-color, #6b7280);"></p>

<section class="dashboard-section">
  <h2 style="margin: 0 0 8px; font-size: 16px; font-weight: 600;">
    {% if is_tenant %}
      {% translate "Expense per Month" %}
    {% else %}
      {% translate "Income per Month" %}
    {% endif %}
  </h2>
  <div class="chart-card">
    <div class="chart-wrap">
      <canvas id="income-chart"></canvas>
    </div>
  </div>
</section>

<section class="dashboard-section" style="margin-top: 24px;">
  <h2 style="margin: 0 0 8px; font-size: 16px; font-weight: 600;">
    {% translate "Water / Electricity Trends" %}
  </h2>
  <div class="chart-card">
    <div class="chart-wrap">
      <canvas id="usage-chart"></canvas>
    </div>
  </div>
</section>

<details style="margin-top: 24px;">
  <summary style="cursor:pointer; font-weight:600;">
    {% translate "Recent actions" %}
  </summary>
  <div style="margin-top: 10px;">
    {% get_admin_log 5 as admin_log for_user user %}
    {% if not admin_log %}
      <p class="quiet">{% translate "None available" %}</p>
    {% else %}
      <ul class="recent-actions-list">
        {% for entry in admin_log %}
          <li class="recent-actions-item {% if entry.is_addition %}is-add{% elif entry.is_change %}is-change{% elif entry.is_deletion %}is-delete{% endif %}">
            <div class="recent-actions-main">
              <span class="recent-actions-label">
                {% if entry.is_addition %}{% translate "Added" %}
                {% elif entry.is_change %}{% translate "Updated" %}
                {% elif entry.is_deletion %}{% translate "Deleted" %}
                {% else %}{% translate "Action" %}{% endif %}
              </span>
              <span class="recent-actions-object">
                {% if entry.is_deletion or not entry.get_admin_url %}
                  {{ entry.object_repr|admin_log_title }}
                {% else %}
                  <a href="{{ entry.get_admin_url }}">{{ entry.object_repr|admin_log_title }}</a>
                {% endif %}
              </span>
            </div>
            {% if entry.change_message and "ACTION:" in entry.change_message %}
              {% with status_class=entry.change_message|admin_log_status %}
                <div class="recent-actions-status {% if status_class %}status-{{ status_class }}{% endif %}">
                  {{ entry.change_message|admin_log_line }}
                </div>
              {% endwith %}
            {% endif %}
            <div class="recent-actions-time">
              {% if entry.action_time %}{{ entry.action_time|timesince }} {% translate "ago" %}{% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</details>

{{ income_labels|json_script:"income-labels" }}
{{ income_values|json_script:"income-values" }}
{{ water_labels|json_script:"water-labels" }}
{{ water_values|json_script:"water-values" }}
{{ elec_labels|json_script:"elec-labels" }}
{{ elec_values|json_script:"elec-values" }}
{{ voice_summary_km|json_script:"voice-summary-text" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    var isDark = document.documentElement.getAttribute("data-theme") === "dark";
    var gridColor = isDark ? "rgba(148, 163, 184, 0.25)" : "rgba(148, 163, 184, 0.18)";
    var textColor = isDark ? "#e2e8f0" : "#334155";

    var numberLocale = "fr-FR";
    var numberFormatter = null;
    try {
      numberFormatter = new Intl.NumberFormat(numberLocale);
    } catch (e) {
      numberFormatter = null;
    }
    function formatNumber(value) {
      if (value === null || value === undefined || value === "") {
        return "";
      }
      if (numberFormatter) {
        return numberFormatter.format(value);
      }
      return String(value);
    }

    var incomeLabels = JSON.parse(document.getElementById("income-labels").textContent || "[]");
    var incomeValues = JSON.parse(document.getElementById("income-values").textContent || "[]");
    var waterLabels = JSON.parse(document.getElementById("water-labels").textContent || "[]");
    var waterValues = JSON.parse(document.getElementById("water-values").textContent || "[]");
    var elecLabels = JSON.parse(document.getElementById("elec-labels").textContent || "[]");
    var elecValues = JSON.parse(document.getElementById("elec-values").textContent || "[]");

    var incomeCtx = document.getElementById("income-chart");
    if (incomeCtx) {
      new Chart(incomeCtx, {
        type: "line",
        data: {
          labels: incomeLabels,
          datasets: [
            {
              label: "{% if is_tenant %}{% translate "Expense" %}{% else %}{% translate "Income" %}{% endif %}",
              data: incomeValues,
              borderColor: "#16a34a",
              backgroundColor: "rgba(22, 163, 74, 0.18)",
              unit: "៛",
              fill: true,
              tension: 0.35,
              pointRadius: 3,
              pointHoverRadius: 5,
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              position: "top",
              labels: {
                color: textColor,
                boxWidth: 18,
                usePointStyle: true,
              },
            },
            tooltip: {
              backgroundColor: isDark ? "#111827" : "#0f172a",
              titleColor: "#fff",
              bodyColor: "#fff",
              padding: 10,
              cornerRadius: 8,
              callbacks: {
                label: function (context) {
                  var label = context.dataset.label || "";
                  var value = formatNumber(context.parsed.y);
                  var unit = context.dataset.unit || "";
                  return label ? label + ": " + value + (unit ? " " + unit : "") : value + (unit ? " " + unit : "");
                },
              },
            },
          },
          scales: {
            x: { grid: { color: gridColor }, ticks: { color: textColor } },
            y: {
              beginAtZero: true,
              grid: { color: gridColor },
              ticks: {
                color: textColor,
                callback: function (value) {
                  return formatNumber(value);
                },
              },
            },
          },
        },
      });
    }

    var usageCtx = document.getElementById("usage-chart");
    if (usageCtx) {
      new Chart(usageCtx, {
        type: "line",
        data: {
          labels: waterLabels.length ? waterLabels : elecLabels,
          datasets: [
            {
              label: "{% translate "Water" %}",
              data: waterValues,
              borderColor: "#0ea5e9",
              backgroundColor: "rgba(14, 165, 233, 0.14)",
              unit: "m³",
              fill: true,
              tension: 0.35,
              pointRadius: 3,
              pointHoverRadius: 5,
              borderWidth: 2,
            },
            {
              label: "{% translate "Electricity" %}",
              data: elecValues,
              borderColor: "#2563eb",
              backgroundColor: "rgba(37, 99, 235, 0.16)",
              unit: "kWh",
              fill: true,
              tension: 0.35,
              pointRadius: 3,
              pointHoverRadius: 5,
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              position: "top",
              labels: {
                color: textColor,
                boxWidth: 18,
                usePointStyle: true,
              },
            },
            tooltip: {
              backgroundColor: isDark ? "#111827" : "#0f172a",
              titleColor: "#fff",
              bodyColor: "#fff",
              padding: 10,
              cornerRadius: 8,
              callbacks: {
                label: function (context) {
                  var label = context.dataset.label || "";
                  var value = formatNumber(context.parsed.y);
                  var unit = context.dataset.unit || "";
                  return label ? label + ": " + value + (unit ? " " + unit : "") : value + (unit ? " " + unit : "");
                },
              },
            },
          },
          scales: {
            x: { grid: { color: gridColor }, ticks: { color: textColor } },
            y: {
              beginAtZero: true,
              grid: { color: gridColor },
              ticks: {
                color: textColor,
                callback: function (value) {
                  return formatNumber(value);
                },
              },
            },
          },
        },
      });
    }
  })();
</script>
<script>
  (function () {
    var params = new URLSearchParams(window.location.search);
    if (!params.has("pw_changed")) return;
    var message = "{% translate 'Your password was changed successfully.' %}";
    var list = document.querySelector(".messagelist");
    if (!list) {
      list = document.createElement("ul");
      list.className = "messagelist";
      document.body.appendChild(list);
    }
    var li = document.createElement("li");
    li.className = "success";
    li.textContent = message;
    list.appendChild(li);

    params.delete("pw_changed");
    var newUrl = window.location.pathname + (params.toString() ? "?" + params.toString() : "");
    window.history.replaceState({}, "", newUrl);

    setTimeout(function () {
      li.classList.add("is-fading");
      setTimeout(function () {
        li.remove();
      }, 400);
    }, 3000);
  })();
</script>
<script>
  (function () {
    var textEl = document.getElementById("voice-summary-text");
    var textDisplay = document.getElementById("voice-summary-display");
    var playBtn = document.getElementById("voice-summary-play");
    var autoToggle = document.getElementById("voice-summary-auto");
    if (!textEl || !playBtn || !autoToggle) return;

    var summaryText = "";
    try {
      summaryText = JSON.parse(textEl.textContent || '""');
    } catch (e) {
      summaryText = (textEl.textContent || "").trim();
    }
    if (textDisplay) {
      textDisplay.textContent = summaryText;
    }
    var storageKey = "voiceSummaryAuto";
    var autoOn = localStorage.getItem(storageKey) === "1";
    autoToggle.checked = autoOn;

    function pickVoice() {
      var voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
      if (!voices.length) return null;
      var kmVoice = null;
      for (var i = 0; i < voices.length; i++) {
        var v = voices[i];
        if (v.lang && v.lang.toLowerCase().indexOf("km") === 0) {
          kmVoice = v;
          break;
        }
      }
      return kmVoice;
    }

    function speak() {
      if (!summaryText || !window.speechSynthesis) return;
      var utter = new SpeechSynthesisUtterance(summaryText);
      utter.lang = "km-KH";
      var voice = pickVoice();
      if (voice) utter.voice = voice;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    playBtn.addEventListener("click", speak);
    autoToggle.addEventListener("change", function () {
      localStorage.setItem(storageKey, autoToggle.checked ? "1" : "0");
      if (autoToggle.checked) {
        speak();
      }
    });

    if (autoOn) {
      speak();
    }

    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = function () {
        if (autoOn) speak();
      };
    }
  })();
</script>
{% endblock %}





